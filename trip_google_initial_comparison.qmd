---
website:
  navbar:
    background: primary
    search: true
    left:
      - text: "Home"
        href: "www.aimdata.org"
      - talks.qmd
      - about.qmd
title: "Google restaurant reviews in Kuala Lumpur, Petaling Jaya and Shah Alam, Malaysia"
subtitle: "AIMdata(https://www.aimdata.org)"
execute: 
  echo: false
toc: true
toc-location: left
toc-depth: 4
format: 
  html:
    code-fold: true
    code-summary: "Show code"
    page-layout: full
    self-contained: true
---

```{css, echo=FALSE}

#TOC::before {
  content: "";
  display: block;
  height: 100px;
  margin: 2em 20px 40px 20px;
  background-image: url("https://github.com/AIMdata-org/aimdata-org.github.io/raw/main/img/logo_squares.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```


```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(scales)
library(tidytext)
library(widyr)
library(ggraph)
library(patchwork)
library(kableExtra)
library(fuzzyjoin)
library(viridis)
library(textdata)

`%out%` <- Negate(`%in%`)
options(scipen = 100)
theme_set(theme_light())
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```


```{r data}
google_reviews <- read_csv("./data/GoogleReview_data_cleaned.csv") |> clean_names()

trip_reviews <- read_csv("./data/TripAdvisor_data_cleaned.csv") |> clean_names() |> 
  mutate(review = str_replace_all(review, "dim sum|Dim Sum|Dim sum", "dimsum"))
```

## Introduction and overview

We're looking at two different datasets of scraped data: restaurant reviews from Google and Trip Advisor in Malaysia. They were both scraped by Ng Choon Khon using the Selenium library and cleaned by him as well. 

Below, we've plotted out the restaurants found in both datasets according to the number of reviews and their mean rating. Immediately, we note an unnatural pattern in the Google dataset: Selenium is limited to scraping around 300 reviews from Google. Whilst this impacts and limits the dataset, we should still make the best use of it we can: Google's official API only allows five reviews to be extracted per restaurant because data freely given to the world and the rest of humanity must be paywalled and sold back to you. 

Data is not meant to create a tool or an app, it is meant to create information. 

<br>

```{r fig.width=7}
google_reviews |> 
  filter(location %in% c("Petaling Jaya", "KL")) |> 
  count(restaurant) |> 
  ggplot(aes(x = n)) + 
  geom_histogram(binwidth = 1/30) + 
  # geom_freqpoly(colour = "blue", alpha = .3) +
  scale_x_log10(breaks = c(0, 10, 30, 100, 300, 1000), 
                labels = comma) + 
  labs(title = "Google reviews per restaurant", 
       subtitle = "Largely limited to 300 reviews per restaurant",
       x = "Number of reviews", 
       y = "Number of restaurants") +

trip_reviews |> 
  filter(location %in% c("Petaling Jaya", "KL")) |> 
  count(restaurant) |> 
  ggplot(aes(x = n)) + 
  geom_histogram(binwidth = 1/30) + 
  # geom_freqpoly(colour = "blue", alpha = .3) +
  scale_x_log10(breaks = c(0, 10, 30, 100, 300, 1000), 
                labels = comma) + 
  labs(title = "Trip Advisor reviews per restaurant", 
       subtitle = "No limits for number of reviews scraped",
       x = "Number of reviews", 
       y = "Number of restaurants") +

  plot_annotation(
    title = "The Trip Advisor reviews dataset has a much more natural distribution"
  )

```

<br>

Google reviews are sorted by default by "relevance", so it is also not possible to say whether the reviews picked up by Selenium were the most recent, highest quality (word count, images), or were regarded by the community or Google as useful, just that it was some combination of those factors. 

As we look into these datasets, let's bear these limitations in mind: 
-Google dataset is not a representative sample of reviews, as many restaurants only have the first 300 most "relevant" reviews.
-Both Google maps and Trip Advisor are principally English language platforms when it isn't spoken by the majority of the population. Upon a cursory inspection, there are very few reviews in Malay.  
-The price range is missing from this data. 
-These reviews were extracted three years ago: some of these restaurants have closed. Before we re-scrape the data and update these datasets, let's see what is of most in the existing data (which honestly was probably used to train a model to write fake reviews). 


<br>


## Increasing interpretability: adding cuisine

Let's now add a column for cuisine (the code can be downloaded at the top of the page, but it was a lot of manual work) to increase interpretability and to maximise the usefulness of the data. We'll narrow down the scope to locations in the Klang Valley (KL, PJ and Shah Alam; since I'm most familiar with and most interested in this metro).  



```{r buffet-fusion-lists}

trip_buffet_list <- trip_reviews |> 
  mutate(possible_buffet = ifelse(
    str_detect(review, "Buffet|buffet") | 
      str_detect(title, "Buffet|buffet") |
      str_detect(restaurant, "Buffet|buffet")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            buffet_count = sum(count[possible_buffet == 1])) |> 
  arrange(desc(buffet_count)) |> 
  mutate(buffet_pc = buffet_count / reviews) |> 
  mutate_at(vars(reviews, buffet_count, buffet_pc), ~range_wna(.)) |>  
  mutate(buffet_score = (buffet_count + buffet_pc) / 2) |> 
  arrange(desc(buffet_score)) |> 
  filter(buffet_score >= .2) |> 
  pull(restaurant)

trip_fusion_list <- trip_reviews |> 
  mutate(possible_fusion = ifelse(
    str_detect(review, "Fusion|fusion") | 
      str_detect(title, "Fusion|fusion") |
      str_detect(restaurant, "Fusion|fusion")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            fusion_count = sum(count[possible_fusion == 1])) |> 
  arrange(desc(fusion_count)) |> 
  mutate(fusion_pc = fusion_count / reviews) |> 
  mutate_at(vars(reviews, fusion_count, fusion_pc), ~range_wna(.)) |>  
  mutate(fusion_score = (fusion_count +  fusion_pc) / 2) |> 
  arrange(desc(fusion_score)) |> 
  filter(fusion_score >= .11) |> 
  pull(restaurant)

google_buffet_list <- google_reviews |> 
  mutate(possible_buffet = ifelse(
    str_detect(review, "Buffet|buffet") | 
      str_detect(restaurant, "Buffet|buffet")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            buffet_count = sum(count[possible_buffet == 1])) |> 
  arrange(desc(buffet_count)) |> 
  mutate(buffet_pc = buffet_count / reviews) |> 
  mutate_at(vars(reviews, buffet_count, buffet_pc), ~range_wna(.)) |>  
  mutate(buffet_score = (buffet_count + buffet_pc) / 2) |> 
  arrange(desc(buffet_score)) |> 
  filter(buffet_score >= 0.1764) |> 
  pull(restaurant)

google_fusion_list <- google_reviews |>
  mutate(possible_fusion = ifelse(
    str_detect(review, "Fusion|fusion") |
      str_detect(restaurant, "Fusion|fusion")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            fusion_count = sum(count[possible_fusion == 1])) |> 
  arrange(desc(fusion_count)) |> 
  mutate(fusion_pc = fusion_count / reviews) |> 
  mutate_at(vars(reviews, fusion_count, fusion_pc), ~range_wna(.)) |>  
  mutate(fusion_score = (fusion_count +  fusion_pc) / 2) |> 
  arrange(desc(fusion_score)) |> 
  filter(fusion_score >= .11) |> 
  pull(restaurant)
```



```{r reviews-cuisine-cleaning}

reviews_cuisine_cleaning <- function(tbl) {
  
  tbl |> 
    # Not a specific restaurant
    filter(restaurant %out% c("Jalan Alor", "Sham's Cooked With Love", "Hawker Stalls in Chinatown",
                              "Feast Village Starhill Gallery", "ICC Pudu", "Imbi Market", 
                              "Taste of Asia", "Thirty8 Fashion", "Happy Mansion")) |> 
    # Some cleaning 
    mutate(restaurant = str_replace(restaurant, "Birch", "Huckleberry")) |> 
    mutate(restaurant = str_replace_all(restaurant, "Passage thru'", "Passage Thru"),
           restaurant = str_replace_all(restaurant, "Gravybaby", "GravyBaby"), 
           restaurant = str_replace_all(restaurant, "Ploy", "PLOY"), 
           restaurant = ifelse(restaurant == "What Tasty Food", "WTF - What Tasty Food", restaurant),
           restaurant = ifelse(restaurant == "ATAS", "ATAS at The RuMa Hotel & Residences", restaurant), 
           restaurant = ifelse(restaurant == "Al Rawsha Restaurant Kuala Lumpur", "Al Rawsha Restaurant", restaurant), 
           restaurant = ifelse(restaurant == "Aliyaa", "Aliyaa Island Restaurant & Bar", restaurant), 
           restaurant = ifelse(restaurant == "Arthur's Bar & Grill, Shangri-La Hotel, Kuala Lumpur", 
                               "Arthur's Bar & Grill", restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Lemon Garden"), 
                               "Lemon Garden", 
                               restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Din Tai Fung at The Gardens Mall"),
                               "Din Tai Fung at The Gardens Mall", 
                               restaurant), 
           restaurant = ifelse(restaurant == "Monnalisa Italian Restaurant", 
                               "Monnalisa Ristorante Italiano", 
                               restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Fatty Mee Hoon Kuih"), 
                               "Fatty Mee Hoon Kuih", 
                               restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Whisky Bar KL"), 
                               "The Whisky Bar", 
                               restaurant), 
           restaurant = str_replace_all(restaurant, "W XYZ", "WXYZ"), 
           restaurant = ifelse(restaurant == "The Daily Grind Bangsar", 
                               "The Daily Grind", 
                               restaurant), 
           restaurant = ifelse(restaurant == "Chili's 1 Utama", "Chili's", restaurant), 
           restaurant = str_replace_all(restaurant, "Merini", "Marini"))  |>
    mutate(
      cuisine = case_when(
        
        # The order of the case_when statements is important. Particularly, it should go
        # South Asian -> Buffet -> Fusion,
        # This is because I would consider South Asian buffet restaurants as South Asian.
        # And I would not consider hotel buffets to be a type of fusion restaurant, 
        # despite all the types of food they might serve.
        # Also, Grill before Bar.
        
          str_detect(
          restaurant,
          "Grill|Steakhouse|Grub|Steak|Brasserie|steakhouse|BBQ|Rock Salt Restaurant|BBP|Churrascaria|Marble 8|Beast|Nando's|Nandos|Bar B Q|Down to Bones|Barbecue|Vantador|Bbq|Butcher Carey|PRIME|Brasserie|Karnivormalaya|Chamber's"
        ) ~ "Grill",
          str_detect(restaurant,
          "Bistro|Deli|Secret Recipe|Tujo|Wild Sheep|Antipodean|Coffee|One Half|Blue Room|Awesome Canteen|Botanica|Chili's|Don's Diner|GravyBaby|Hornbill|Huck's|myBurgerLab|Naj & Belle|Tony Roma's|Louisiana|Cor Blimey|4Fingers|Bacon And Balls|POP PIZZA|After Black|Ashley's by Living Food|March Azalea Kitchen|Mighty Monster IPC|Sköhns Canteen|Table9|Rabbit Hole|Williams Corner|Tiki Taka|4 Fingers|Ben's|Souled Out|Suzi's Corner|Fuel Shack Signature|SOULed OUT|TGI Friday|Chilli's|Pigs & Wolf|Ship|Breakfast Thieves|Ante|Morganfield's|Subway|Meat The Porkers|Pan & Tamper|Hubba Mont Kiara|Bacon & Balls|Tate|Gin Ger|Fuel Shack|Jarrod & Rawlins|BreadFruits|Glass Tartines and Tipples|B-Lab|Mighty Monster|Ticklish Ribs|Cozy Corner|Duddha|Fat Brother|Define:food|Tangerine|Sausage & Ribs Shack|Texas Chicken|Coco Fika|Andra By Gula Cakery|D Place|Chef Zubir|Hubz|Maipi Corner|Marrybrown|Meet and Meat|Jibby & Co|Midwest|WhupWhup|Foodilicious Kitchen Shah Alam|Craveat"
        ) ~ "Casual Western",
        str_detect(
          restaurant,
          "Chinese|Taiwan|[\\p{Han}]|Nam Heong|Dynasty|Putien|Hoi|Gold Dragon|Han Room|Village Duck|Village Roast Duck|Unique|Steamboat|Ah |Roast Pork|Hokkien Mee|Dim Sum|Lai Po Heen|Yun House|Chynna|Li Yen|Shanghai|Lai Foong|Little Penang Kafé|Goon Wah|Shang Palace|YEN|Yut Kee|Din Tai Fung|Dragon-i|Celestial Court|The Ming Room|Sai Woo|Luk Yu|Yue|Way Modern Chinois|Hong Kong|Blue Boy Vegetarian Food Centre|Xin|Lai Ching Yuen|Noble House|Noodle House|Bak Kut|Fong Lye|Wan Tan Mee|Sarawak Laksa|Hakka|Ruyi & Lyn|Chicken rice|Chicken Rice|Char Siew|Siew Yoke|Dim Sum|Chiu Chow|Hainan|Hailam|Pork Noodles|Koong Woh Tong|Yong Tow Foo|Madam Tang| Kee|The Pot KL|Yu Noodle Cuisine|Wan Chun Ting|Muk Koot|Oversea|Marco Polo|Cu Cha Restaurant|Imperial|Grand Harbour|In Colonial Restaurant|Museum Restaurant|Heng|Hiong Kong|Ban Lee Restaurant|Heong|Restaurant Mama Love|Hee Lai Ton|New Paris|Kingdom Palace|Siu Siu|Sam You|Ti Chen|Mee Hoon|Fishball|Peoh|Esquire|Restourant Boston|7th Mile Kitchen"
        ) ~ "Chinese",
        str_detect(
          restaurant,
          "Italia|Olive|Ristorante|Osteria|Prego|Pizza|Trattoria|Nero Nero|Positano|a'Roma|Vin's Restaurant|Michelangelo|Marini's|Nizza|Porto Romano|Tatto|Neroteca|La Risata|Portofino|Ciao|Enoteca|Mangiare|Sassolino|Pizzeria|La Casa Restaurant & Patisserie|Favola|Senja Restaurant|Graze"
        ) ~ "Italian",
        str_detect(
          restaurant,
          "German|French|Chez|Marta's|Tapas|Bistro à Table|Iberico|El Toro Loco|Petit|Mercat|Dominic|El Cerdo|Quivo|Skillet KL|iberico|Yeast|Maison Francaise|El Mesón|Lafite|Topshelf|Wurst|Sabayon|Chateau|Naughty Babe Dirty Duck|Hit & Mrs|Le Gourmandin|Soleil|Suisse|IKEA|Leonardo|MARCO Creative Cuisine|Abanico|La Belle Saison"
        ) ~ "European",
        str_detect(restaurant, "Thai|Bangkok|BKK|Baan|Tamarind Springs|Chakri|BAAN|Samira by Asian Terrace|Ekkamai|Busaba|Mamasan|Krung Thep|Tomyam|Aroma Restaurant|Chef Korn|Tuk Tuk"
                   ) ~ "Thai",
        str_detect(restaurant, "Arab|Turkish|Al-|Halab|Egyptian|Tarbush|Wadi|Sahara Tent|Shawarma|Damascus|Syria|Hadramawt|diafah|Iraq|Sarifa|Al Rawsha|The Castle Restaurant|Saba Restaurant|Marhaba|ALRAWSHA Restaurant|Antara|Andalus|El Sham|Oregi Restaurant"
                   ) ~ "Levantine",
        # Malay (Chef Wan) and Malaysian (Madan Kwan's)
        str_detect(
          restaurant,
          "Malay|Rasa|Cik|Dapur|Rebung|Zakhir|Village Park|ADU|Warisan|Nasi|Dancing Fish|Sarang|Bijan|Serai|Sambal|ATAS|Grandmama's|Onde Onde|JP teres|Satay Station|Chef Wan|De.Wan|Siti Li Dining|Pintu|Ramly|Penyet|Sepiring|Satay|Restoran Ali Food Corner|Open House|Sup Utara|Bawal Power|Ikan|Gulai|Kampung Mu|Marlina Station|Wong Solo|Bawang|Goreng"
        ) ~ "Malay",
        str_detect(
          restaurant,
          "Nonya|Baba|Mum's Place|Madam Kwan|Chuup|Old China Cafe|Nyonya|Little Penang|Oriental Cravings|Papparich|Uncle Don|Muar Restaurant|Kumi|Peranakan|1919 Restaurant"
        ) ~ "Malaysian",
        str_detect(
          restaurant,
          "Japan|Edo|Sushi|Kampachi|Iketeru|Menya|Nobu|Omakase|TOKYO|Tokyo|Tonkatsu|Udon|Soba|Ichibanya|Maruhi|Omulab|Zipangu|Miyabi|Izakaya Hanazen|hokkaido|Senya|IPPUDO|Umai-Ya|Ichiban|Yakiniku|Nihon|Lucky Tora|Hokkaido|Mo-Mo Paradise|Sushi|sushi|Uokatsu|Ramen|Tempura|Izakaya|Tokyo|Kyoto|Oishii|Gyoza|Ichiban|Tonkotsu|Tonkatsu|Sakura|Yakitori|Kyush|Teppanyaki|Taka|Kikubari|Ichiyutei|Enju|Okonomi|Toridoki|Syokudo|Tsukiji|Yuzu|Madam Salma|Fu-Rin"
        ) ~ "Japanese",
        # Why not merge all Korean BBQ into grill?
        str_detect(
          restaurant,
          "Filipino|Bali|Vietnam|GOODDAM|Korea|Sao Nam|Naughty Nuri's|KyoChon|Viet|Dakgalbi|Sopoong|Kung Jung|Saigon|Sae Ma Eul|KoRyo-Won|Koryowon|Persia|Astana|Buns & Noodles|Kyochon|Topokki"
        ) ~ "Other Asian",
        
        # Do not str_detect(.x, "bar")
        str_detect(restaurant, "Whisky|Lounge|Bar|Decanter|Knowhere Bangsar|The Locker & Loft|Tom, Dick & Harry's|WET|The Enclave|Out of Africa|Opium|THIRTY8|Healy Mac's|TEMPTationS|Loco bar|La Bodega|Vertigo|The Social|No Black Tie|The BAR|O'Galito|Table 23|D Legends bar|Bobo KL|Rock Bottom|twenty-one kitchen+bar|Bentley's Pub|Vinh City Entertainment|twenty-one|Malones|White Horse Tavern|Supperclub KL|Backyard|The Ceylon bar|W1 Dining & Cocktails|Splash|Drop Exchange|Boardwalk|Deep Blue|The Sticky Wicket|OneSixFive|The Attic|Concubine KL|The Green Man|THE BAR|Marini’s on 57|Rooftop 25"
        ) ~ "Bar",
        str_detect(restaurant, "Cafe|Grind|Café|Tujo|cafe|Alexis|The Loaf|Yellow Brick Road|Huckleberry|TWG|Newens Tea House|Miss Ellie Tea House|Frisky Goat|Urbean|Ra-Ft|Backofen|STG Bukit Ceylon|VCR|Rise & Shine by Tapestry|Kafe|Kaffe|Kopi|Latte|Kopitiam"
        ) ~ "Cafe",
        str_detect(
          restaurant,
          "Kerala|India|Lanka|Malabar|Curry|Raju|Bhavan|Thosai|Tandoor|Bombay|Gem Restaurant|Nasi Kandar|NADODI|Qureshi|RSMY|Sangeetha|Nirwana|Asian Rice Pot|Masala|Annalakshmi|Aliyaa|MTR|Devi's Corner|WTF - What Tasty Food|Nadodi|Delhi Royale|FLOUR|Bakti Woodlands|Vishal Food|Banana Leaf|Hyderabad|sarvana bhavan|Spice Garden|Roti|TasteBud|Chapati|Pakistani|Jai Hind|BananaBro|Naan|SK Corner|Sri Paandi|Majapahit|Nan |GinRikSha|Briyani|Biryani|Maju Palace|Seetharam|Havelly|Punjab|Goa By Sapna Anand|Swaadisht|Mamak|Sri|Chapathi|Moghul|Rani|Aryan|Yarl|Sagar|ABC Foods Corner|Sheesh Mahal|Mallikas"
        ) ~ "South Asian",
        
        # Buffet list
        restaurant %in% trip_buffet_list ~ "Buffet",
        restaurant %in% google_buffet_list ~ "Buffet", 
        str_detect(restaurant, "Flock, W Kuala Lumpur|HYdeout By Grand Hyatt Kuala Lumpur|Curate"
                   ) ~ "Buffet", 
        # List of fusion restaurants
        restaurant %in% trip_fusion_list ~ "Fusion",
        restaurant %in% google_fusion_list ~ "Fusion", 
        str_detect(restaurant, "Symphony by Chef Jo|Darren Chin|Dewakan|DC Restaurant|Sitka|Ginger Restaurant|Table & Apron|Foodsbury"
                   ) ~ "Fusion", 
        
        # Unfortunate, there aren't enough Latino restaurants for their own category
        str_detect(restaurant, "Latino|Mexican|Carretas|Mexico|Frontera|Mexicana|Cocina"
        ) ~ "Other",
        str_detect(restaurant, "Oliver Gourmet|Seafood|Shell Out|BAIT|Fisherman|Fish & Co|Shucked|Delay No More Crab Restaurant|Ombak"
        ) ~ "Seafood",
        str_detect(restaurant, "Vasco's|Latest Recipe|Lemon Garden|Prime|Gastro Sentral|Chinoz On The Park|Shook|Plane In The City|Contango|The Living Room|Curate At Four Seasons|Beta KL|CEDAR on 15|The Apartment|The Grand Getaway|Strato|Ril's|Chocha|Wizards at Tribeca|Nipah|Joloko|Leonardo's Dining Room & Wine Loft|Roofino Skydining|Troika|Dining In The Dark KL|PLOY|Atlas Gourmet Market|WIP|Nathalie Gourmet Studio|Altitude|The Canteen by Chef Adu|Latitude 03|The Orchid Conservatory|Graze Restaurant|Zende Restaurant|Crystal|Cielo KL|Cedar On 15"
        ) ~ "Other Upmarket",
        # Just mopping up all the Dai Chow
        # I feel this is going to create problems down the line
        str_detect(restaurant, "Restoran"
        ) ~ "Chinese",
        TRUE ~ "Other"
  )) |> 
    mutate(rowid = row_number())
}


```


```{r trip-kl-cuisine and google-kl-cuisine}
trip_kl_cuisine <- trip_reviews |> 
  filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
  reviews_cuisine_cleaning() 

google_kl_cuisine <- google_reviews |> 
  filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
  reviews_cuisine_cleaning()

summary_stats <- rbind(
trip_kl_cuisine |>
  mutate(count = 1) |> 
  group_by(restaurant) |> 
  mutate(reviews = sum(count)) |> 
  ungroup() |> 
  filter(reviews >= 20) |> 
  summarise(mean_rating = mean(rating), 
            median_rating = median(rating), 
            mode_rating = Mode(rating)) |> 
  mutate(source = "Trip Advisor"),

google_kl_cuisine |>
  mutate(count = 1) |> 
  group_by(restaurant) |> 
  mutate(reviews = sum(count)) |> 
  ungroup() |> 
  filter(reviews >= 20) |> 
  summarise(mean_rating = mean(rating), 
            median_rating = median(rating),
            mode_rating = Mode(rating)) |> 
  mutate(source = "Google")
)
```


Determining the cuisine of a restaurant should be fairly obvious in most cases. Additional notes on the coding of these cuisines may be found in the appendices. 

Let's take a look at an overview of both datasets with cuisines included. From the plot below, we see that: 

* South Asian, Chinese, Casual Western, Japanese and Bars are the most commonly-reviewed (and the most common?)  restaurants in the Klang Valley.  
* Chinese, Casual Western, Malaysian and Thai are the lowest-rated cuisines. 
* Fusion, Other Upmarket (experiential dining or unspecified "international" cuisine) and bars have the highest ratings, with 60% or more of all reviews being five stars. 
* Trip Advisor and Google reviewers differ the most on their opinions of Levantine, Casual Western and Japanese cuisine. 


<br>


```{r fig.width=7}
google_kl_cuisine |> 
  mutate(count = 1) |> 
  group_by(cuisine) |> 
  summarise(reviews = n(), 
            five_star_reviews = sum(count[rating == 5]), 
            mean_rating = mean(rating)) |> 
  mutate(five_star_pc = five_star_reviews / reviews, 
         source = "Google")|> 
  select(five_star_pc, cuisine, source, reviews, mean_rating) |> 
  rbind(
    trip_kl_cuisine |> 
      mutate(count = 1) |> 
      group_by(cuisine) |> 
      summarise(reviews = n(), 
                five_star_reviews = sum(count[rating == 5]), 
                mean_rating = mean(rating)) |> 
      mutate(five_star_pc = five_star_reviews / reviews, 
             source = "Trip Advisor") |> 
      select(cuisine, five_star_pc, source, reviews, mean_rating)
  ) |> 
  ggplot(aes(x = five_star_pc, 
             y = fct_reorder(cuisine, mean_rating), 
             fill = mean_rating)) + 
  geom_col(alpha = .7) + 
  scale_x_continuous(labels = percent) +
  geom_text(aes(label = comma(reviews)), 
            position = position_dodge(width = .9), 
            hjust = "inward", 
            colour = "grey20") + 
  scale_fill_viridis(direction = -1, begin = .15, option = "turbo") +
  facet_wrap(~ source) + 
  guides(fill = "none") + 
  theme(strip.background = element_rect(fill = "black"), 
        strip.text = element_text(face = "bold")) +
  labs(x = "% of reviews that are five-stars", 
       y = "", 
       title = "Mean rating of restaurants on Google and Trip Advisor, by cuisine", 
       subtitle = "Only restaurants in the Klang Valley. Total number of reviews in black.")
  

```

<br>

 
With reference to the scatterplots below, that ratings are skewed towards the higher end: the mean rating of restaurants on Google is **`r summary_stats |> filter(source == "Google") |> pull(mean_rating) |> round(2)`** and the mean rating on Trip Advisor is **`r summary_stats |> filter(source == "Trip Advisor") |> pull(mean_rating) |> round(2)`**. The median and mode for both datasets is **5**. This means that the median rating for a restaurant will likely provide a better centre for the data as the mean can be pulled down significantly by outlier low-starred reviews. 

For both restaurants in Trip Advisor and Google, the higher the number of reviews, the higher the mean rating. Maybe popularity is an indicator of excellence? In food, at least.


<br>


```{r restaurant-comparison-trip-google, fig.width=8, warning=FALSE, message=FALSE}

compare_google_trip <- function(tbl){
  
  tbl |> 
    group_by(restaurant, cuisine) |> 
    summarise(reviews = n(), 
              mean_rating = mean(rating), 
              median_rating = median(rating), 
              mode_rating = Mode(rating),
              .groups = "drop") |>  
    filter(reviews >= 20)
  }

plot_google_trip <- function(tbl){
  
  tbl |> 
    ggplot(aes(x = reviews, 
               y = mean_rating)) +
    geom_point(aes(colour = median_rating), 
               alpha = .4) + 
    # scale_size_continuous(limits = c(1, 10)) +
    scale_x_log10() +
    scale_colour_viridis(option = "turbo", begin = .15, end = .9, direction = -1, 
                         labels = label_number(accuracy = .1)) +
    # ggrepel::geom_text_repel(aes(label = cuisine)) + 
    geom_smooth(method = "lm", alpha = .1, size = 0, span = .5) + 
    geom_smooth(method = "lm", se = FALSE, alpha = .1, size = .2) + 
    labs(subtitle = "Restaurants with less than 20 reviews excluded", 
         x = "Number of reviews",
         y = "Mean Rating",
         colour = "Median Rating") +
    theme(legend.title = element_text(size = 9), 
          legend.text = element_text(size = 7),
          legend.key.size = unit(0.9, "lines"))
    
}
  

google_kl_cuisine |> 
  compare_google_trip() |> 
  plot_google_trip() + 
  # ylim(3.8, 4.6) +
  labs(title = "Google reviews") +
  guides(size = guide_legend(override.aes = list(alpha = 1))) +

trip_kl_cuisine |> 
  compare_google_trip() |> 
  plot_google_trip() + 
  # ylim(3.8, 4.6) +
  labs(title = "Trip Advisor reviews") +
  guides(size = "none") +
  
  plot_annotation(title = "Klang Valley restaurants and average ratings") +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")

ggsave("./plots/cuisine_comparison_trip_google.png", height = 7, width = 11, units = "in")

```



<br>



Just having these two sets of reviews to examine, 

Are reviews useful? The commonality of five-star reviews indicate that the mean rating is more likely an indicator of expectations being met rather than any true excellence. 

## In both Google and Trip

These differences probably come down to the reviewers on Google and Trip Advisor and their respective purposes. Google reviewers are often locals or general consumers, whilst Trip Advisor reviewers tend to be travellers who have to provide more structured, specific reviews, leading to less casual reviews as there is a minimum word count required. 

```{r restaurant-fuzzy-match}

restaurant_fuzzy_match <- stringdist_join(
  trip_reviews |> 
    filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
    distinct(restaurant) |> 
    mutate(restaurant_match = str_remove_all(restaurant, "Restaurant|Cuisine|restaurant|Restoran|Curry House|Japanese"), 
           restaurant_match = trimws(restaurant_match)) |> 
    select(restaurant_trip = restaurant, 
           restaurant_match), 
  google_kl_cuisine |> filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
    distinct(restaurant)|> 
    mutate(restaurant_match = str_remove_all(restaurant, "Restaurant|Cuisine|restaurant|Restoran|Curry House|Japanese"),
           restaurant_match = trimws(restaurant_match)) |> 
    select(restaurant_google = restaurant, 
           restaurant_match), 
  by = "restaurant_match", 
  ignore_case = TRUE, 
  method = "jw",
  max_dist = 99, 
  distance_col = "dist"
) |> 
  group_by(restaurant_match.x) |> 
  slice_min(order_by = dist, n = 1) |> 
  arrange((dist)) |> 
  select(match_x = restaurant_match.x, 
         match_y = restaurant_match.y, 
         dist,
         restaurant_google, 
         restaurant_trip) |>
  ungroup()

both_google_and_trip <- restaurant_fuzzy_match |> 
  filter(match_x != "Teh Laris Cafe" | match_y != "Thosai Cafe") |> 
  filter(match_x != "The Ming Room" | match_y != "The Living Room") |>
  filter(match_x != "Cilantro & Wine Bar" | match_y != "ZENZERO & Wine Bar") |> 
  filter(match_x != "Kedai Kopi Pak Ngah" | match_y != "Kedai Kopi Lai Foong") |> 
  filter(match_x != "Shanghai" | match_y != "Old Shanghai") |> 
  filter(match_x != "Ah Ni Bak Kut Teh" | match_y != "Ah Sang Bak Kut Teh") |> 
  filter(match_x != "Pin Wei Seafood" | match_y != "Hoi Peng Seafood") |> 
  filter(match_x != "Cafe Cafe" | match_y != "Cafe ETC") |> 
  filter(match_x != "Tao Chinese" | match_y != "Ee Chinese") |>
  filter(match_x != "Seoul Garden" | match_y != "Lemon Garden") |>
  filter(match_x != "De.Wan" | match_y != "Dewakan") |>
  filter(dist <= 0.16666667)

combined_google_trip <- trip_kl_cuisine |> 
  filter(restaurant %in% both_google_and_trip$restaurant_trip) |> 
  select(cuisine, location, restaurant, rating, review) |>
  mutate(source = "TripAdvisor") |> 
  rbind(
    google_kl_cuisine |> 
      filter(restaurant %in% both_google_and_trip$restaurant_google) |> 
      select(cuisine, location, restaurant, rating, review) |> 
      mutate(source = "Google")
  ) |> 
  mutate(row_id = row_number()) |> 
  left_join(
    both_google_and_trip |> 
      distinct(restaurant_google, restaurant_trip) |>
      rename(restaurant = restaurant_trip),
    by = c("restaurant")
  ) |> 
  left_join(
    both_google_and_trip |> 
      distinct(restaurant_google, restaurant_trip) |>
      rename(restaurant = restaurant_google),
    by = c("restaurant")
  ) |> 
  mutate(restaurant_new = ifelse(!is.na(restaurant_google), 
                                 restaurant_google, 
                                 restaurant)) |> 
  group_by(row_id, location, cuisine, restaurant = restaurant_new, review, source) |> 
  summarise(rating = mean(rating), 
            .groups = "drop") |> 
  mutate(restaurant = trimws(restaurant))

```



```{r common-restaurants, fig.height=6, fig.width=10}
combined_google_trip |> 
  group_by(restaurant, source) |> 
  summarise(rating = mean(rating), 
          .groups = "drop") |> 
  pivot_wider(names_from = source, 
              values_from = rating) |> 
  left_join(
    combined_google_trip |> 
      count(restaurant, 
            name = "count"), 
    by = "restaurant"
  ) |> 
  left_join(
    combined_google_trip |> 
      distinct(restaurant, cuisine), 
    by = "restaurant"
  ) |> 
  filter(!is.na(Google) & !is.na(TripAdvisor)) |> 
  ggplot(aes(x = Google, y = TripAdvisor)) + 
  geom_point(aes(colour = cuisine, 
                 size = count)) + 
  scale_colour_viridis_d(option = "turbo") +
  ggrepel::geom_text_repel(aes(label = restaurant), 
                           size = 1.2) + 
  labs(title = "Comparison between Google and TripAdvisor restaurant ratings", 
       subtitle = "Size indicates number of reviews", 
       y = "Trip Advisor mean rating", 
       x = "Google mean rating", 
       colour = "Cuisine", 
       size = "Review count") + 
  # guides(colour = guide_legend(override.aes = list(size = .7))) +
  theme(legend.title = element_text(size = 6), 
        legend.text = element_text(size = 6), 
        legend.key.size = unit(0.3, "lines"))

ggsave("./plots/restaurant_comparison_trip_google.png", height = 7, width = 11, units = "in")  
```

<br>

Google and TripAdvisor users seem to agree more than disagree. 
Five-star

It's possible that reviews are useless. 

Good service and environment can prevent a one-star review. 
Humans are crazy and feel debts viscerally. 
Separate food from service and waiters? But restaurants don't do that. 
Dining is an experience, and all aspects of the experience are vital. 

```{r}
google_kl_cuisine |> 
  filter(str_detect(review, "zahangir")) |> 
  pull(review)
```

Maybe there should be separate scores for the food and the service? 
How do 